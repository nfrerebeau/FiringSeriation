---
title: "Assessing the Firing of Ceramic Materials: a Seriation-Based Approach"
author:
  - Nicolas Frerebeau:
      correspondence: "yes"
      email: nicolas.frerebeau@u-bordeaux-montaigne.fr
      orcid: 0000-0001-5759-4944
      affiliations:
        - name: "UMR 6034 Archéosciences Bordeaux"
          address: "Maison de l'Archéologie, Université Bordeaux Montaigne"
          city: Pessac cedex
          country: France
          postal-code: 33607
          url: https://www.archeosciences-bordeaux.fr
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  pdf: 
    documentclass: scrartcl
    include-in-header: 
      - text: |
          \usepackage{booktabs}
    classoption: 
      - french
      - 12pt
      - a4paper
      - oneside
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
knitr:
  opts_chunk:
    echo: false
    warning: false
    message: false
    comment: "#>"
    fig.path: "../figures/"
    fig.dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: [references.bib, packages.bib]
csl: "../templates/archeosciences.csl"
abstract: |
  The study of the firing of archaeological ceramics is thus a key factor in 
  interpreting ancient techniques and related social practices. This study 
  proposes a new method based on the correspondence analysis of powder X-ray 
  diffraction data (XRD), aiming to provide an alternative to the so-called
  Equivalent Firing Temperature framework. The properties of correspondence 
  analysis and its application for matrix seriation enable the description of 
  the firing of a ceramic assemblage. The application of correspondence 
  analysis to XRD data of Iron Age ceramics revealed the  significant potential 
  of this statistical method in the technological analysis of ancient pottery. 
  This allows to order of a large number of samples according to a firing 
  gradient and to track mineralogical transformations occurring during firing.
keywords: |
  X-ray diffraction; ceramic firing; correspondence analysis; matrix seriation
---

```{r}
#| label: setup
options(knitr.kable.NA = "")
```

Keywords: `r rmarkdown::metadata$keywords`

\newpage

# License {-}

This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).

# Change record {-}

| **Version** | **Date**   | **Description**            | **DOI** |
|------------:|-----------:|:---------------------------|:--------|
| 0.0.0.9000  |  | Submitted to _Archéosciences_ |  |

```{r}
#| label: graphical-abstract
#| fig-align: center
#| out.width: "4in"
knitr::include_graphics(here::here("analysis/figures/abstract.png"))
```

\newpage

<!-- The actual document text starts here: -->

# Introduction

Firing is a "strategic step" [@lemonnier1983a] of the ceramic production process: its success largely determines the final mechanical, refractory and --- to some extent --- aesthetic properties of the artifacts. Moreover, in case of failure this step involves the risk of losing all or part of the load to be fired and the associated human labor time. The study of the firing of archaeological ceramics is thus a key factor in interpreting ancient techniques and related social practices. In this regard, significant methodological research has been carried out since the pioneering work of @shepard1936, leading to the widespread use of the so-called *Equivalent Firing Temperatures* (EFT) as a way to describe the firing of archaeological ceramics [@tite1969; @tite1969a]. The EFT is a point estimator tied to standard experimental conditions, defined as "the temperature maintained for one hour which would produce the observed mineralogy or microstructure" [@tite1995].

The EFT is undoubtedly practical, but it raises several methodological and conceptual problems. A full review is beyond the scope of this study [see @frerebeau2018 for a detailed discussion], but two points can be made. On the one hand, EFT creates unnecessary ambiguity about the real firing temperature. Tite [-@tite1995; -@tite1999] points out that the EFT does not account for the temperature within the firing structure. At best, it serves as an indication of the heat transmitted during the firing process that led to the observed transformations (mineralogical or microstructural), i.e., a combination of temperature and time. On the other hand, @gosselain1992 and @livingstonesmith2001 have highlighted the limitations of this framework. EFT alone does not provide a precise understanding of the firing conditions or the specific firing techniques employed.

Therefore, this study proposes a new method based on the multivariate analysis of powder X-ray diffraction (XRD) data, aiming to provide an alternative to the EFT framework. This method follows the principle of parsimony and has two main objectives: (1) to avoid the use of external references, whether experimental or ethnographic data; (2) to construct the simplest possible model by limiting the number of hypotheses involved.

XRD is routinely used to investigate the mineralogical composition of archaeological ceramic bodies. Typically, XRD is employed qualitatively, focusing on identifying mineralogical phases that have formed during firing, for understanding the firing history and the transformations that occurred within the ceramic material. Quantitative analysis of XRD data faces significant difficulties due to the multiphase nature, poor crystallization, and amorphous content of archaeological ceramics. Estimating quantitative mineralogical compositions through methods like the RIR method [@hubbard1988] or Rietveld refinement [@rietveld1969] is a challenging and highly skilled exercise, requiring in-depth knowledge of the material.

Limited work has been done on the use of multivariate methods for the analysis of X-ray diffraction data from archaeological materials. Different approaches have been used such as Lineal Discriminant Analysis [@garciagimenez2006], Principal Component Analysis [@delavilla2003; @holakooei2014] or hierarchical clustering [@piovesan2013; @maritan2015], mainly for classification purposes.

In this study, we show that correspondence analysis (CA) of X-ray diffractograms can be used to assess the firing of ceramic materials. The properties of correspondence analysis and its application for matrix seriation enable the description of the firing of a ceramic assemblage and identification of outliers. Calibration data sets can be produced solely based on archaeological evidence to assess ceramic firing practices, eliminating the need for laboratory references. To illustrate this method, we examine XRD data of Iron Age ceramics from the Mas de Moreno workshop (Teruel, Aragon, Spain).

# Material and method
## Archaeological samples

Sampling was carried out in such a way that each sample was taken from a single artifact. Particular attention was paid to the risk of contamination by systematically discarding sherds that had been glued back together or that had undergone any chemical treatment.

```{r}
#| label: archaeological-data
## Read archaeological data
corpus <- here::here("analysis/data/raw_data/corpus.csv") |>
  read.table(sep = ",", dec = ".", header = TRUE, encoding = "UTF-8")
```

`r sum(corpus$material == "ceramic" & corpus$site == "Mas de Moreno")` ceramics from the Mas de Moreno workshop (Foz-Calanda, Teruel, Aragon) were sampled to represent the entire period of the workshop's activity (@tbl-corpus). The workshop was active between 225-200 BC and 40-30 AD. Previous archaeological studies of the workshop have highlighted three successive phases of activity, characterized by changes in the productive space and the emergence of Roman elements [@gorgues2007; @gorgues2012]. Several kilns have been excavated, with discontinuation and destruction occurring around 50-40 BC [@gorgues2012]. The use of a larger amphora kiln, the production of Roman amphorae, and the presence of Latin epigraphy indicate a major reorganization of the workshop in the middle of the 1st century. The workshop ceased its activity in the following decade due to territorial reorganization under Roman influence and its distance from trade routes [@gorgues2012]. This workshop provides a context well-suited for investigating the technological choices related to ceramic firing in the Ebro Valley at the end of the Iron Age.

The ceramic material of the Mas de Moreno consists only of products known as Iberian painted/fine wares. It refers to a wheel thrown production, with a pink uniform colour and a dark red painted decor, with no temper visible to the naked eye and considered to be fired at high temperatures in an oxidizing atmosphere [@tarradell1980; @mata1992; @collconesa2000]. Although Iberian fine wares present a significant technological uniformity [@tarradell1980], the sampling was conducted in such a way that all types of pottery produced in the workshop were included in the study (non-Iberian types produced at the end of the workshop's activity period were also sampled).

A number of fragments of unfired potteries were also found during the excavation of the workshop [for a complete presentation of these unfired potsherds, see @frerebeau2017]. Of these, `r sum(corpus$material == "clay" & corpus$site == "Mas de Moreno")` samples have been analysed here (@tbl-corpus).

Finally, `r sum(corpus$material == "ceramic" & corpus$site != "Mas de Moreno")` additional Iberian fine wares were sampled (@tbl-corpus). These came from two settlements close to the workshop: Torre Cremada (Valdeltormo, Teruel, Aragon; `r sum(corpus$site == "Torre Cremada")` samples from the 1^st^ century BC) and El Palao (Alcañiz, Teruel, Aragon; `r sum(corpus$site == "El Palao")` samples dated between the 8^th^ and the 4^th^ century BC). Comparisons with these two settlements are not intended to establish genetic relationships (in a provenance meaning), but rather to propose a comparative technology study. Samples from El Palao and Torre Cremada have the same compositional ranges in the CaO-Al~2~O~3~-SiO~2~ system and belong to the same category of Iberian fine wares as the material from Mas de Moreno (see below).

```{r}
#| label: tbl-corpus
#| tbl-cap: "Ceramic and clay samples analyzed in this study. Phase 1 : 2nd century BC; Phase 2: first half of the 1st century BC; Phase 3: 50-30 BC. SU: stratigraphic unit. LOI: loss on ignition [see @frerebeau2020a; @frerebeau2015e; @frerebeau2015g]."
corpus[order(corpus$sample), !(colnames(corpus) %in% c("site_type", "decoration", "part"))] |> 
  knitr::kable(
    col.names = c("Sample", "Material", "Site", "SU", "Phase", "Type", "LOI (%)"),
    booktabs = TRUE,
    longtable = TRUE
  )
```

## Powder X-ray diffraction

```{r}
#| label: xrd-data
## Read XRD data 
## (see analysis/supplementary-materials/01-data.R)
xrd_counts <- here::here("analysis/data/derived_data/xrd_clean.csv") |> 
  read.table(sep = ",", dec = ".", header = TRUE)

## Remove the first column (2 theta positions)
theta_scale  <- xrd_counts[, 1]
xrd_counts <- xrd_counts[, -1]

## Transpose (one sample per line)
xrd_counts <- xrd_counts |> t() |> as.data.frame()
colnames(xrd_counts) <- paste0("T", seq_len(ncol(xrd_counts)))

## Get index of XRD columns
xrd_col <- which(grepl(pattern = "T", colnames(xrd_counts)))

## Read mineral data
minerals <- here::here("analysis/data/raw_data/minerals.csv") |>
  read.table(sep = ",", dec = ".", header = TRUE, encoding = "UTF-8") |> 
  subset(symbole %in% c("An", "Cal", "Gh", "Ilt", "Qz", "Di"))
# minerals <- minerals[!duplicated(minerals$symbole), ]
```

The mineralogical composition of the samples was determined by X-ray powder diffraction. The outer surfaces of all the samples were mechanically removed prior to analysis. Then, approximately 1 g of material per sample was manually powdered in an agate mortar.

The data were collected using a D8 Advance (Bruker) diffractometer in Bragg-Brentano configuration operating at 1.6 kW (40 kV, 40 mA) and equipped with a copper anode source ($k_{\alpha1}$ = 1.5406 Å; the $k_\beta$ ray was removed by a Ni-filter in the diffracted beam). An 8 mm anti-scattering slit was mounted in front of the LynxEye© CCD detector. The explored area covered the 3-70° ($2\theta$) range, with an angle step of 0.02° and a time step of 2 seconds (the sample was rotated during the analysis). The stability of the instrument was checked between different series of measurements by analyzing a standard (corundum crystal, NIST 1976).

All diffractograms were processed in the same way:

* $k_{\alpha2}$ lines were stripped using penalized likelihood [@derooi2014].
* All diffractograms were checked for possible sample displacements due to inaccurate powder sample mounting and then shifted accordingly (using quartz as an internal standard).
* All diffractograms were realigned to a common angular scale using linear interpolation between data points.
* Baselines were estimated using iterative mean suppression [4S Peak Filling, @liland2015] and then removed (negative values due to baseline subtraction were replaced by zeros).
* Data points below 4° ($2\theta$) and above 54° ($2\theta$) were removed.

Finally, all the diffractograms were combined into a `r paste0(dim(xrd_counts[, xrd_col]), collapse = " x ")` matrix where each row corresponds to a sample and each column corresponds to a $2\theta$ position. Each cell contains the corresponding X-ray photon count.

## Correspondence analysis

We will only briefly recall the main aspects of correspondence analysis, as a detailed review of its mathematical properties is beyond the scope of this article [for an in-depth discussion, see @greenacre2007; @lebart2006].

Correspondence analysis (CA) is similar to principal component analysis (PCA) in that it allows describing the statistical relationships that can exist between individuals and variables. However, the concept of similarity between rows and columns is different. In CA, two rows (resp. columns) are close to each other if they associate with columns (resp. rows) in the same way. Unlike PCA, CA analyzes the differences between relative values and considers both individuals and variables at the same time (this allows for the projection of row and column points in the same coordinate space). CA studies the inertia (i.e., the weighted sum of the χ2 distances of each point to the centroid) to create orthogonal components so that a maximum of the total inertia is represented on the first component, a maximum of the residual inertia on the second component, and so on until the last dimension. CA maximizes the correspondence between individuals and variables instead of maximizing the amount of variance explained by its reduced space.

CA is an effective method for the chronological seriation of archaeological assemblages [see @ihm2005 for an historical overview]. The order of the rows and columns is given by the coordinates along one dimension of the CA space, assumed to account for temporal variation. The direction of temporal change within the correspondence analysis space is arbitrary: additional information is needed to determine the actual order in time. CA is not limited to chronological modeling but is widely used to find a possible arrangement (ordering) of individuals and variables along any gradient, i.e., any aspect that is expected to be related to the observed composition (be it temporal or environmental).

## Computational environment

```{r}
#| label: bib-packages
# Créer automatiquement une bibliographie des packages R utilisés
dep <- here::here("DESCRIPTION") |> readLines()
dep <- dep[seq(from = grep(pattern = "Imports", x = dep) + 1, 
               to = max(grep(pattern = "^[[:space:]]", x = dep)))]
dep <- gsub("[[:space:][:punct:][:digit:]]*", "", dep)
dep <- c(dep, "base") # Add R base

cite <- lapply(
  X = dep,
  FUN = function(x) {
    bib <- try(citation(x), silent = FALSE)
    if (inherits(bib, "try-error")) return(NULL)
    entry <- utils::toBibtex(bib)
    entry[1] <- sub("\\{,$", sprintf("{R-%s,", x), entry[1])
    entry
  }
)
here::here("analysis/paper/packages.bib") |> 
  cat(unlist(cite), file = _, sep = "\n")

pkg <- vapply(
  X = dep[dep != "base" & dep != "here"], 
  FUN = function(x) {
    sprintf("`%s` %s [@R-%s]", x, packageVersion(x), x)
  }, 
  FUN.VALUE = character(1)
)
```

All the data processing and statistical analysis were performed with `r R.version$version.string` [@R-base] and the following packages: `r paste0(pkg, collapse = ", ")`. The R code is openly available in @frerebeau2023a and allows to replicate all the results presented below.

# Results and discussion
## Correspondence analysis

```{r}
#| label: ca-moreno
## Mas de Moreno: ceramics + unfired sherds
sup_row_id <- match(corpus$sample[corpus$site != "Mas de Moreno"], rownames(xrd_counts))
xrd_moreno_ca <- dimensio::ca(object = xrd_counts[, xrd_col], sup_row = sup_row_id)

## Get CA results
xrd_moreno_eig <- dimensio::get_eigenvalues(xrd_moreno_ca)
xrd_moreno_row_coord <- dimensio::get_coordinates(xrd_moreno_ca, margin = 1)
xrd_moreno_col_coord <- dimensio::get_coordinates(xrd_moreno_ca, margin = 2)
xrd_moreno_col_contrib <- dimensio::get_contributions(xrd_moreno_ca, margin = 2)
```

The results of the correspondence analysis of the diffractograms are presented in @fig-plot-ca. Only the data from the analysis of the samples from Mas de Moreno were used, including unfired ceramics and shards. The data from El Palao and Torre Cremada were introduced into the analysis as supplementary individuals. These additional individuals do not contribute to the calculation of the correspondence analysis itself, but they are projected onto the existing analysis space to visualize their relationships with the original dataset.

The first two dimensions are sufficient to retain about `r round(xrd_moreno_eig[2, 3])`% of the total inertia contained in the data (@fig-plot-ca A and B). Plotting the coordinates of the individuals shows an interesting pattern (@fig-plot-ca C). The upper quadrants each consist of a small group of closely located individuals, likely exhibiting high similarity to one another. The remaining samples are distributed in the lower quadrants.

```{r}
#| label: fig-plot-ca
#| fig-cap: "CA results of the XRD patterns of the Mas de Moreno samples. (A) Scree plot of inertia (only the first ten components are displayed). (B) Cumulative inertia of the first ten components. (C) CA rows score plot. (D) CA columns score plot, displaying only the main diffraction lines of a selected set of minerals of interest for improved readability. Ilt: illite; Cal: calcite; Qz: quartz; Gh: gehlenite; Di: diopside; An: anorthite."
#| fig-width: 10
#| fig-height: 10
## Plot eigenvalues
par(mar = c(4, 4, 1, 1), mfrow = c(2, 2))
mid <- barplot(
  height = xrd_moreno_eig[1:10, 1],
  names.arg = rownames(xrd_moreno_eig)[1:10],
  ylab = "Inertia (%)", las = 1, ylim = c(0, 0.3)
)
text(x = min(mid), y = 0.29, labels = "A", font = 2, cex = 1.5)

## Plot cumulative inertia
plot(
  x = 1:10,
  y = xrd_moreno_eig[1:10, 3],
  type = "b",
  pch = 16,
  col = "red",
  xaxt = "n",
  xlab = "",
  ylab = "Cumulative inertia (%)", las = 1
)
text(x = 1, y = 92, labels = "B", font = 2, cex = 1.5)
axis(side = 1, at = 1:10, labels = rownames(xrd_moreno_eig)[1:10])

## Active rows (F1 vs F2)

theta_minerals <- vapply(
  X = minerals$theta,
  FUN = function(x, theta) { which.min(abs(theta - x)) },
  FUN.VALUE = numeric(1),
  theta = theta_scale
)
xrd_minerals_coord <- xrd_moreno_col_coord[theta_minerals, ]
xlim <- range(range(xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1]), range(xrd_minerals_coord[, 1]))
ylim <- range(range(xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2]), range(xrd_minerals_coord[, 2]))

plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2],
  xlim = xlim, ylim = ylim,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = 16,
  las = 1, asp = 1,
  col = "black"
)
text(x = min(xlim), y = max(ylim) + 0.25, labels = "C", font = 2, cex = 1.5)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")

## Columns (F1 vs F2)
# plot(
#   x = xrd_moreno_col_coord[, 1],
#   y = xrd_moreno_col_coord[, 2],
#   xlim = xlim, ylim = ylim,
#   xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
#   ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
#   type = "p",
#   pch = 16,
#   las = 1, asp = 1,
#   col = adjustcolor("black", alpha = 0.2)
# )
# text(x = min(xlim), y = max(ylim) + 0.25, labels = "D", font = 2, cex = 1.5)
# abline(h = 0, lty = 2, col = "darkgrey")
# abline(v = 0, lty = 2, col = "darkgrey")
col_minerals <- khroma::color("bright")(6)
plot(
  x = xrd_minerals_coord[, 1],
  y = xrd_minerals_coord[, 2],
  xlim = xlim, ylim = ylim,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = 16,
  las = 1, asp = 1,
  col = col_minerals[as.factor(minerals$symbole)]
)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")
text(
  x = xrd_minerals_coord[, 1],
  y = xrd_minerals_coord[, 2],
  labels = mapply(
    FUN = function(s, h, k, l) {
      if (h < 0) as.expression(bquote(.(s)~"("*bar(.(abs(h)))*.(k)*.(l)*")"))
      else as.expression(bquote(.(s)~"("*.(h)*.(k)*.(l)*")"))
    }, 
    s = minerals$symbole,
    h = minerals$h, 
    k = minerals$k,
    l = minerals$l
  ),
  col = col_minerals[as.factor(minerals$symbole)],
  pos = c(2,3, 2, 1, 4, 4, 4, 2, 2, 2, 4, 3, 3, 4, 3, 1, 4)
)
text(x = min(xlim), y = max(ylim) + 0.25, labels = "B", font = 2, cex = 1.5)
```

@fig-plot-contrib shows the contribution of the different columns to the construction of the first two CA-axes. It is important to note that the analysis is performed on the diffractograms: a diffraction peak represents a range of $2\theta$ positions, spanning multiple columns in the data matrix. Consequently, the columns that contribute the most to the construction of the first axis (with a contribution greater than 0.5) are associated with the following diffraction peaks: 21.94° (plagioclases), 26.64° (quartz), 27.76° (plagioclases), 27.90° (plagioclases), and 29.42° (calcite). Similarly, for the second axis, the columns that contribute the most are those corresponding to the peaks at 12.32° (phyllosilicate), 26.66° (quartz), and 31.36° (melilites).

```{r}
#| label: fig-plot-contrib
#| fig-cap: Columns contribution to the construction of the first two components. The twenty variables contributing the most to each component are highlighted in red. 
#| fig-width: 10
#| fig-height: 5
par(mar = c(0, 4, 1, 1), mfrow = c(2, 1), oma = c(3, 0, 0, 0))
plot(
  x = theta_scale,
  y = xrd_moreno_col_contrib[, 1],
  type = "l",
  las = 1,
  ylab = "Contribution to F1",
  xaxt = "n"
)
abline( #21.94, 27.76-27.9, 29.42
  v = theta_scale[order(xrd_moreno_col_contrib[, 1], decreasing = TRUE)[1:20]],
  col = adjustcolor(col = "red", alpha = 0.5)
)
# pks_contrib1 <- alkahest::peaks_find(
#   x = theta_scale,
#   y = xrd_moreno_col_contrib[, 1],
#   SNR = 2,
#   m = 5
# )
# dput(pks_contrib1$x[pks_contrib1$y > 0.5])
# points(x = pks_contrib1$x[pks_contrib1$y > 0.5],
#        y = pks_contrib1$y[pks_contrib1$y > 0.5])

plot(
  x = theta_scale,
  y = xrd_moreno_col_contrib[, 2],
  type = "l",
  las = 1,
  ylab = "Contribution to F2"
)
abline( #12.32, 26.66, 31.36
  v = theta_scale[order(xrd_moreno_col_contrib[, 2], decreasing = TRUE)[1:20]],
  col = adjustcolor(col = "red", alpha = 0.5)
)
mtext(expression(2*theta), side = 1, line = 2, outer = TRUE)
# pks_contrib2 <- alkahest::peaks_find(
#   x = theta_scale,
#   y = xrd_moreno_col_contrib[, 2],
#   SNR = 2,
#   m = 5
# )
# dput(pks_contrib2$x[pks_contrib2$y > 0.5])
# points(x = pks_contrib2$x[pks_contrib2$y > 0.5],
#        y = pks_contrib2$y[pks_contrib2$y > 0.5])
```

The first plane of the analysis exhibits the characteristic Guttman effect, also known as the arch effect (@fig-plot-ca, @fig-plot-guttman). This effect is characterized by a strong nonlinear relationship between the second factor and the first factor. The Guttman effect typically arises when a single dominant latent variable is present [@lebart2014]. Interestingly, the samples located in the upper right quadrant of the correspondence analysis plot are linked to diffraction peaks that correspond to clay minerals and calcite (@fig-plot-guttman A, @fig-plot-ca D, @fig-plot-xrd). These samples are positioned opposite to the ones associated with the peaks of diopside and anorthite along axis 1. Conversely, the samples located in the two lower quadrants are linked to the peaks of quartz and the melilite series.

```{r}
#| label: fig-plot-guttman
#| fig-cap: "Guttman effect observed on the first plane of correspondence analysis: row coordinates are highlighted based on material (A), chronological phase (B), and supplementary individuals with 95% probability ellipses (C). CaO-SiO2-Al2O3 ternary plot of the ceramic samples (D). Qz: quartz; Gh: gehlenite; An: anorthite; Wo: wollastonite; mul: mullite; crn: corundum. Data from @frerebeau2015g and @frerebeau2015e."
#| fig-width: 10
#| fig-height: 10
layout(matrix(data = c(1, 3, 2, 4), ncol = 2))
par(mar = c(4, 4, 1, 1))

xlim <- range(range(xrd_moreno_row_coord[, 1]))
ylim <- range(range(xrd_moreno_row_coord[, 2]))

id_moreno <- match(rownames(xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, ]), corpus$sample)

## F1 vs F2: active only, by material
col_material <- khroma::color("high contrast")(2)
plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2],
  xlim = xlim, ylim = ylim,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = c(16, 17)[as.factor(corpus$material[id_moreno])],
  las = 1, asp = 1,
  col = col_material[as.factor(corpus$material[id_moreno])]
)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")
text(x = min(xlim), y = max(ylim) + 0.25, labels = "A", font = 2, cex = 1.5)
legend("bottomright", legend = levels(as.factor(corpus$material[id_moreno])),
       pch = c(16, 17), col = col_material)

## F1 vs F2: active only, chronology
col_phase <- khroma::color("bright")(3)
plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2],
  xlim = xlim, ylim = ylim,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = c(21, 22, 23)[as.factor(corpus$phase[id_moreno])],
  las = 1, asp = 1,
  col = "black",
  bg = col_phase[as.factor(corpus$phase[id_moreno])]
)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")
text(x = min(xlim), y = max(ylim) + 0.25, labels = "B", font = 2, cex = 1.5)
legend("bottomright", 
       legend = paste0("Phase ", levels(as.factor(corpus$phase[id_moreno]))),
       pch = c(21, 22, 23), col = "black", pt.bg = col_phase)

## F1 vs F2: active and supplementary rows
col_site <- khroma::color("vibrant")(2)
plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2],
  xlim = xlim, ylim = ylim,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = 16,
  las = 1, asp = 1,
  col = "lightgrey"
)
points(
  x = xrd_moreno_row_coord[xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[xrd_moreno_row_coord$.sup, 2],
  pch = c(24, 25)[as.factor(corpus$site[corpus$site != "Mas de Moreno"])],
  bg = col_site[as.factor(corpus$site[corpus$site != "Mas de Moreno"])]
)
car::dataEllipse(
  x = as.matrix(xrd_moreno_row_coord[xrd_moreno_row_coord$.sup, 1:2]),
  groups = as.factor(corpus$site[corpus$site != "Mas de Moreno"]),
  group.labels = NULL,
  level = 0.95,
  col = col_site,
  plot.points = FALSE,
  center.pch = NULL,
  add = TRUE
)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")
text(x = min(xlim), y = max(ylim) + 0.25, labels = "C", font = 2, cex = 1.5)
legend("bottomright", legend = c(levels(as.factor(corpus$site[corpus$site != "Mas de Moreno"])), "Mas de Moreno"),
       pch = c(24, 25, 16), pt.bg = col_site, col = c("black", "black", "lightgrey"))

## Ternary plot
xrf_cas <- here::here("analysis/data/derived_data/xrf_cas.csv") |> 
  read.table(header = TRUE, sep = ",", dec = ".") |> 
  subset(sample %in% corpus$sample)

par(mar = c(1, 1, 1, 1))
isopleuros::ternary_plot(
  xrf_cas[xrf_cas$site == "Mas de Moreno", c("CaO", "Al2O3", "SiO2")],
  col = "lightgrey", pch = 16, ylab = ""
)
isopleuros::ternary_points(
  xrf_cas[xrf_cas$site != "Mas de Moreno", c("CaO", "Al2O3", "SiO2")],
  pch = c(24, 25)[as.factor(xrf_cas$site[xrf_cas$site != "Mas de Moreno"])],
  bg = col_site[as.factor(xrf_cas$site[xrf_cas$site != "Mas de Moreno"])]
)
isopleuros::triangle_phase_ceramic(symbol = TRUE)
text(x = 0, y = 0.9, labels = "D", font = 2, cex = 1.5)
```

```{r}
#| label: fig-plot-xrd
#| fig-cap: "Diffractograms of representative samples from each quadrant of the CA plot (see @fig-plot-ca). From top to bottom: upper left quadrant (BDX14922), lower left quadrant (BDX15451), lower right quadrant (BDX15465), upper right quadrant (BDX22203). Only the peaks that contribute the most to the construction of the first two CA axes are indexed (see text and @fig-plot-contrib)."
#| fig-width: 10
#| fig-height: 11
par(mfrow = c(4, 1), mar = c(1, 0, 1, 1), oma = c(4, 4, 4, 0))

pks <- c(c(21.94, 26.64, 27.76, 27.9, 29.42), c(12.32, 26.66, 31.36))
## Upper left quadrant
plot(
  x = theta_scale,
  y = xrd_counts[rownames(xrd_counts) == "BDX14922", ] / 1000,
  type = "l",
  xaxt = "n",
  yaxt = "n",
  ylab = "",
  las = 1
)
abline(v = pks, lty = 2)
axis(side = 3, at = pks)
text(x = min(theta_scale) + 1, y = 55, labels = "BDX14922", font = 2)
## Bottom left quadrant
plot(
  x = theta_scale,
  y = xrd_counts[rownames(xrd_counts) == "BDX15451", ] / 1000,
  type = "l",
  xaxt = "n",
  yaxt = "n",
  ylab = "",
  las = 1
)
abline(v = pks, lty = 2)
text(x = min(theta_scale) + 1, y = 35, labels = "BDX15451", font = 2)
## Bottom right quadrant
plot(
  x = theta_scale,
  y = xrd_counts[rownames(xrd_counts) == "BDX15465", ] / 1000,
  type = "l",
  xaxt = "n",
  yaxt = "n",
  ylab = "",
  las = 1
)
abline(v = pks, lty = 2)
text(x = min(theta_scale) + 1, y = 35, labels = "BDX15465", font = 2)
## Top right quadrant
plot(
  x = theta_scale,
  y = xrd_counts[rownames(xrd_counts) == "BDX22203", ] / 1000,
  type = "l",
  yaxt = "n",
  ylab = "",
  las = 1
)
abline(v = pks, lty = 2)
text(x = min(theta_scale) + 1, y = 15.5, labels = "BDX22203", font = 2)

mtext(expression(2*theta), side = 1, line = 3, cex = 1, outer = TRUE)
mtext("Count (a. u.)", side = 2, line = 2, cex = 1, outer = TRUE)
```

The Guttman effect arises from the unimodal distribution of observed variables along a gradient, suggesting the possibility of ordering these variables along the same gradient. Our results strongly suggest that the gradient under consideration is related to the firing process: the first axis represents the opposition between minerals present in the raw material and those formed during firing. These secondary minerals gradually form during the firing process as conditions change and are likely to be used in subsequent chemical reactions. Hence, a unimodal distribution can be expected for various $2\theta$ positions along this gradient.

## Ceramic firing

The production of ceramic materials involves solid-state transformations where the mineralogical composition of the final product differs from that of the raw material [@heimann1989]. This is particularly true for Ca-rich ceramics, where the formation of new Ca-silicates can occur. The energy required for these transformations is supplied in the form of heat during firing, without reaching melting. As a result, the transformation process tends toward thermodynamic equilibrium but never fully achieves it [@grapes2010, 191]. One of the reasons for this deviation from equilibrium lies in the control exerted by reaction kinetics during ceramic firing [@treiman1983; @heimann1989; @heimann2019]. The majority of archaeological ceramic materials are characterized by frozen-in phase transitions [@rocabois2001; @tsuchiyama1983; @heimann2019].

Archaeological ceramic thus constitute highly heterogeneous materials, allowing for the existence of micro-equilibria confined to the reaction interfaces between grains. These micro-equilibria can result in the formation of thermodynamically incompatible mineral phases at the system scale [@maggetti1986; @heimann2019]. However, the appearance of new phases is dependent on the availability of reactive components, which delays the initiation of these transformations compared to situations described by phase diagrams. Numerous studies have investigated these transformations [see, for instance, @peters1978; @dondi1998; @duminuco1998; @riccardi1999; @cultrone2001; @rathossi2010], we only highlight the main findings in this context.

* During the firing process, the dehydroxylation of clay minerals and the thermal decomposition of calcium carbonates facilitate the availability of highly reactive oxides, enabling the formation of new phases, whether crystalline or not.
* At the interface between quartz and phyllosilicates, the dehydroxylation of phyllosilicates leads to the expected formation of potassium feldspars and alumino-silicates (mullite). Similarly, the interaction between dolomite and quartz is likely to result in the appearance of diopside. Furthermore, the contact between calcite and quartz is expected to produce wollastonite, which appears to be an intermediate reaction promoting the formation of anorthite [@traore2000].
* The interface between calcite, quartz, and phyllosilicates is anticipated to yield different calcium silicates (gehlenite, anorthite, wollastonite, and pyroxenes), sometimes accompanied by phases associated with the dehydroxylation of clay minerals, particularly potassium feldspars. The formation of gehlenite is a phenomenon that is accentuated by local enrichment in CaO.

The principal axis of correspondence analysis is built upon the opposition between primary phases and secondary phases. The resulting projection highlights the progression of firing, in accordance with the expected mineralogical transformations (@fig-plot-ca D). The intermediate position of gehlenite can also be explained. The ceramics from Mas de Moreno all belong to the category of Ca-rich ceramics, as defined by @noll1991 [@frerebeau2020a]: within the CaO-Al~2~O~3~-SiO~2~ system, they fall within the quartz-anorthite-wollastonite triangle (@fig-plot-guttman D). In this case, the formed gehlenite is metastable. It serves as an intermediate product towards the formation of anorthite and wollastonite, linked to the diffusion of calcium through the matrix [@traore2000; @traore2003a]. As gehlenite forms a solid solution with akermanite (the melilite series), it can also promote the crystallization of diopside (primarily of the fassaite type) rather than anorthite [@dondi1998; @rathossi2010].

```{r}
#| label: fig-plot-loi-map
#| fig-cap: "Top: the relationship between loss on ignition (LOI) and CA coordinates is depicted. The red line represents the second-order polynomial fit with an associated 95% confidence interval. Bottom: a heat map of the diffractograms in the 5-35° range ($2\\theta$) is displayed. The samples are ordered based on the first axis of the correspondence analysis. To enhance visualization, a square root transformation was applied."
#| fig-width: 8
#| fig-height: 8
layout(matrix(c(1, 3, 3, 2, 3, 3), ncol = 2))
par(mar = c(4, 4, 1, 2))

loi_moreno <- corpus$LOI[id_moreno]
loi_NA <- is.na(loi_moreno)
loi_moreno[loi_NA] <- min(loi_moreno, na.rm = TRUE)
col_loi <- khroma::ramp(loi_moreno, palette = "YlOrBr")(5)
col_loi[loi_NA] <- "darkgrey"
attr(col_loi,"breaks")[loi_NA] <- NA
loi_moreno[loi_NA] <- NA

## F1 vs F2: LOI
plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 2],
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = sprintf("F2 (%g%%)", round(xrd_moreno_eig[2, 2], 1)),
  type = "p",
  pch = 21,
  las = 1, asp = 1,
  col = "black",
  bg = col_loi
)
abline(h = 0, lty = 2, col = "darkgrey")
abline(v = 0, lty = 2, col = "darkgrey")

## F1 vs LOI
data_fit <- data.frame(
  LOI = loi_moreno,
  F1 = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1]
)
data_fit <- data_fit[stats::complete.cases(data_fit), ] # Remove NA
loi_fit <- lm(LOI ~ poly(F1, 2), data = data_fit)
loi_fit_res <- summary(loi_fit)
seq_F1<- seq(from = min(data_fit$F1), to = max(data_fit$F1), by = 0.1)
loi_pred <- predict(
  object = loi_fit, 
  newdata = data.frame(F1 = seq_F1),
  interval = "confidence", 
  level = 0.95
)

plot(
  x = xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, 1],
  y = loi_moreno,
  xlab = sprintf("F1 (%g%%)", round(xrd_moreno_eig[1, 2], 1)),
  ylab = "LOI (%)",
  type = "p",
  pch = 21,
  las = 1,
  col = "black",
  bg = col_loi
)
polygon(
  x = c(seq_F1, rev(seq_F1)),
  y = c(loi_pred[, "lwr"], rev(loi_pred[, "upr"])),
  col = adjustcolor("black", alpha = 0.2),
  border = NA,
  lwd = 2
)
lines(
  x = seq_F1,
  y = loi_pred[, "fit"], 
  col = "red",
  lwd = 2
)

legend_image <- as.raster(sort(col_loi[col_loi != "darkgrey"]))
rasterImage(legend_image, 0.80, 15, 0.90, 20)
rect(0.80, 15, 0.90, 20)
text(
  x = 0.9, 
  y = c(15, 20), 
  labels = paste0(round(range(attr(col_loi, "breaks"), na.rm = TRUE)), "%"), 
  pos = 4
)

## Heat map
xrd_moreno_row_active <- xrd_moreno_row_coord[!xrd_moreno_row_coord$.sup, ]
which_moreno <- match(rownames(xrd_moreno_row_active), rownames(xrd_counts))
xrd_counts_moreno <- xrd_counts[which_moreno, ]

id_order <- order(xrd_moreno_row_active[, 1])
xrd_reorder <- as.matrix(xrd_counts_moreno[id_order, ])
xrd_reorder <- t(sqrt(xrd_reorder))
# xrd_reorder <- apply(X = xrd_reorder, MARGIN = 1, FUN = function(x) alkahest::rescale_max(seq_along(x), x)$y)

theta_range <- theta_scale >= 5 & theta_scale <= 35
image(
  x = theta_scale[theta_range],
  y = seq_len(ncol(xrd_reorder)),
  z = xrd_reorder[theta_range, ],
  xlab = expression(2*theta), ylab = "",
  yaxt = "n",
  col = khroma::color("YlOrBr")(255)
)
arrows(x0 = 5, y0 = 0, x1 = 5, y1 = 70.5, length = 0.2, lwd = 2, xpd = TRUE)
abline(
  h = which.min(xrd_moreno_row_active[id_order, 1] < 0 & xrd_moreno_row_active[id_order, 2] > 0) - 0.5,
  lty = 2
)
abline(
  h = which.max(xrd_moreno_row_active[id_order, 1] > 0 & xrd_moreno_row_active[id_order, 2] > 0) - 0.5,
  lty = 2
)
axis(side = 4, at = c(11.5, 60.5), labels = FALSE)
mtext(text = "firing gradient", side = 2, line = 0.5)
mtext(text = "unfired", side = 4, line = 0.5, at = 5.5)
mtext(text = "production conditions", line = 0.5, side = 4, at = 35)
mtext(text = "overfired", line = 0.5, side = 4, at = 66)
```

Interestingly, @fig-plot-loi-map (top) illustrates the relationship between the first axis of the correspondence analysis and the loss on ignition (LOI) of the samples [see @frerebeau2020a for the LOI data]. It is observed that the LOI is inversely correlated with the coordinates of the individuals along the first axis. To further explore this relationship, a second-order polynomial regression analysis was conducted. The results indicated that the overall regression was statistically significant (RSE = `r round(loi_fit_res$sigma, 2)` on `r  loi_fit_res$df[2]` degrees of freedom, R^2^ = `r round(loi_fit_res$r.squared, 2)`, adjusted R^2^ = `r round(loi_fit_res$adj.r.squared, 2)`, `r sprintf("F(%g, %g) = %g", loi_fit_res$fstatistic[2], loi_fit_res$fstatistic[3], round(loi_fit_res$fstatistic[1], 1))`, p < 0.001), indicating a good fit of the polynomial regression model to the data.

Therefore, it appears that the ceramics from Mas de Moreno can be ordered according to the progress of these mineralogical transformations or, equivalently, according to the energy received during the firing (@fig-plot-loi-map, bottom).

## Archaeological implications

The material from the Mas de Moreno is the result of waste from the production process. It is therefore necessary to distinguish between what is representative of material produced in the workshop and what is the result of a non-desirable situation leading to deliberate rejection (firing defect). In order to explore these two hypotheses, the diffratograms of several artifacts from consumption contexts (El Palao and Torre Cremada) were introduced into the previous analysis as supplementary individuals. This was made possible by the technical homogeneity of the material studied. Samples from El Palao and Torre Cremada have the same compositional ranges (@fig-plot-guttman D) and belong to the same category of Iberian fine wares as the material from Mas de Moreno.

These additional individuals are all situated in the lower section of the first plane of the correspondence analysis (@fig-plot-guttman C). This enables the differentiation of the artifacts from Mas de Moreno into those associated with regular production and those linked to misfiring (i.e., individuals located in the upper right quadrant; @fig-plot-guttman A, @fig-plot-ca D, @fig-plot-loi-map bottom). Individuals reflecting a typical production pattern exhibit peaks related to gehlenite rather than anorthite and diopside. This suggests a certain level of control over the energy input during firing to allow the development of this intermediate phase.

The firing process must be carefully controlled to maintain a favorable balance between benefits and risks throughout production. In the context of Iberian ceramics, the management of thermal parameters is primarily understood as a strategy to utilize calcareous materials without the risk of lime blowing [@petitdominguez2003; @cultrone2011; @cultrone2014]. However, the thermal decomposition of calcium carbonates is a necessary process to achieve the desired characteristics, especially aesthetic qualities.

By incorporating iron, the formation of calcium silicates during firing limits the development of coloration induced by the presence of iron oxides in the matrix. This occurs because iron can be integrated into amorphous or crystalline phases through substitution, rather than remaining as free oxides, thereby affecting its chromogenic properties. The cations Fe^2+^ and Fe^3+^ are incorporated into pyroxenes (preferably in octahedral coordination) through solid-state diffusion, replacing Mg^2+^ and Ca^2+^ ions, or into melilite-group phases (in tetrahedral coordination). This process prevents the formation of spinel compounds [@vedder1969; @nodari2007] and plays a fundamental role in the manufacturing process of Iberian ceramics, as it allows for the attainment of a characteristic pink-colored surface.

Finally, it is worth noting that there appears to be no relationship with chronology (@fig-plot-guttman B). Despite significant workshop modifications, including the adoption of a large amphora kiln that resulted in a shift in production quantities during the final years of the workshop's operation [@gorgues2012], the produced artefacts exhibit consistent mineralogical characteristics.

# Conclusion

The initial application of correspondence analysis to X-ray powder diffraction data of ceramic materials revealed the significant potential of this statistical method in the technological analysis of ancient pottery. The main advantage is the possibility of ordering a large number of samples according to a firing gradient. This allows for the tracking of mineralogical transformations occurring during firing and facilitates more precise comparisons than those based on estimating the equivalent firing temperature. Furthermore, this method enables the construction of calibration data sets from workshops, which can then be utilized to assess the firing of materials discovered in specific contexts.

However, a number of limitations need to be highlighted. Firstly, this method only allows us to obtain a relative order, without being able to identify any gaps in the sequence. Secondly, this approach relies on homogeneity conditions and mathematical assumptions that can be derived from the conditions formulated by @dunnell1970 for chronological seriation. The homogeneity conditions state that all the groups included in such a study must: (1) be of comparable raw materials, (2) belong to the same technological tradition, (3) show mineralogical transformations related to firing. The mathematical assumptions state that the distribution of any mineralogical class is continuous through firing and exhibits the form of a unimodal curve. This last point is undoubtedly the most delicate, as many diffraction angles are paired with several minerals. Moreover, diffraction patterns depend not only on the mineralogical composition of the samples, but also on instrumental settings and counting statistics, which currently prevents the reuse of data acquired under different conditions.

These constraints will serve as a guide for future work. One of the next steps will be to work on variable selection. The use of whole diffractograms leads to the construction of a data matrix which tend to be sparse (a large portion of entries consists of zeros) and there is much redundant information. Finally, the use of resampling methods, such as bootstrapped approaches, should improve the stability of relative orderings, as shown by @peeples2012.

# Acknowledgements

This study has received a State financial support managed by the French Agence Nationale de la Recherche under the program *Investissements d'avenir* (ANR-10-LABX-52).

The author is grateful to Alexis Gorgues (UMR 5607 Institut Ausonius) and José Antonio Benavente (Consorcio Patrimonio Ibérico de Aragón) for providing access to archaeological material.

# Data availability statement

The data that support the findings of this study are openly available in @frerebeau2015g, @frerebeau2015e, @frerebeau2015h, @frerebeau2015i.

The R code for data cleaning and analysis is openly available as a compendium in @frerebeau2023a. It allows to replicate all the results presented above.

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

# Colophon {-}

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
sessionInfo()
```
